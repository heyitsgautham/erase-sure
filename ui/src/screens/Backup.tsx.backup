import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useApp } from '../contexts/AppContext';
import { useSecureWipe } from '../hooks/useSecureWipe';
import LogViewer from '../components/LogViewer';
import FileLink from '../components/FileLink';
import Progress from '../components/Progress';
import FileBrowser from '../components/FileBrowser';

function Backup() {
    const navigate = useNavigate();
    const { state, addToast, dispatch } = useApp();
    const { backup, running } = us                        )}
                    </div>
                )}
            </div>

            {/* Action Button */}
            <div className="mb-6">
                <button
                    className="btn btn-primary btn-large"
                    onClick={handleRunBackup}
                    disabled={state.isLoading || running}
                    style={{ 
                        width: '100%',
                        background: (state.isLoading || running) 
                            ? 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)'
                            : 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                        fontSize: '1.125rem',
                        fontWeight: '600',
                        padding: '1rem 2rem',
                        borderRadius: '12px',
                        boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)',
                        transition: 'all 0.2s ease'
                    }}
                >
                    {(state.isLoading || running) ? (
                        <div className="flex items-center justify-center gap-3">
                            <div style={{
                                width: '20px',
                                height: '20px',
                                border: '2px solid #ffffff',
                                borderTopColor: 'transparent',
                                borderRadius: '50%',
                                animation: 'spin 1s linear infinite'
                            }}></div>
                            <span>Running Backup...</span>
                        </div>
                    ) : (
                        <div className="flex items-center justify-center gap-3">
                            <span style={{ fontSize: '1.25rem' }}>üõ°Ô∏è</span>
                            <span>Start Encrypted Backup</span>
                        </div>
                    )}
                </button>
            </div>;
    const [destination, setDestination] = useState('~/SecureWipe/backups');
    const [selectedFiles, setSelectedFiles] = useState<string[]>([]);
    const [signKeyPath, setSignKeyPath] = useState('');
    const [useDefaultPaths, setUseDefaultPaths] = useState(true);
    const [showFileBrowser, setShowFileBrowser] = useState(false);

    const handleSelectDestination = async () => {
        try {
            // In production, use Tauri's dialog API
            // const selected = await open({ directory: true });
            // if (selected) setDestination(selected);
            addToast('Folder selection will be implemented with Tauri dialog API', 'info');
        } catch (error) {
            console.error('Failed to select destination:', error);
        }
    };

    const handleRunBackup = async () => {
        if (!state.selectedDevice) {
            addToast('Please select a device first', 'error');
            return;
        }

        if (!destination.trim()) {
            addToast('Please specify a backup destination', 'error');
            return;
        }

        try {
            addToast(`Starting backup of ${state.selectedDevice.model}...`, 'info');

            // Mock progress tracking for demonstration
            const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

            // Step 1: Initialize
            dispatch({
                type: 'SET_PROGRESS',
                payload: {
                    title: 'Encrypted Backup in Progress',
                    currentStep: 1,
                    totalSteps: 5,
                    currentStepName: 'Initializing backup process...',
                    percentage: 0
                }
            });
            await delay(800);

            // Step 2: Encryption Setup
            dispatch({
                type: 'SET_PROGRESS',
                payload: {
                    title: 'Encrypted Backup in Progress',
                    currentStep: 2,
                    totalSteps: 5,
                    currentStepName: 'Setting up AES-256-CTR encryption...',
                    percentage: 25
                }
            });
            await delay(1000);

            // Step 3: Data Copy
            dispatch({
                type: 'SET_PROGRESS',
                payload: {
                    title: 'Encrypted Backup in Progress',
                    currentStep: 3,
                    totalSteps: 5,
                    currentStepName: 'Copying and encrypting data...',
                    percentage: 50
                }
            });
            await delay(1200);

            // Step 4: Verification
            dispatch({
                type: 'SET_PROGRESS',
                payload: {
                    title: 'Encrypted Backup in Progress',
                    currentStep: 4,
                    totalSteps: 5,
                    currentStepName: 'Verifying backup integrity...',
                    percentage: 80
                }
            });
            await delay(900);

            // Step 5: Certificate Generation
            dispatch({
                type: 'SET_PROGRESS',
                payload: {
                    title: 'Encrypted Backup in Progress',
                    currentStep: 5,
                    totalSteps: 5,
                    currentStepName: 'Generating signed certificates...',
                    percentage: 100
                }
            });
            await delay(800);

            const includePaths = !useDefaultPaths && selectedFiles.length > 0 
                ? selectedFiles 
                : undefined;

            await backup({
                device: state.selectedDevice.path,
                dest: destination,
                sign: true,
                signKeyPath: signKeyPath || undefined,
                includePaths,
                allowCritical: state.selectedDevice.risk_level === 'CRITICAL'
            });

            // Show completion state
            dispatch({
                type: 'SET_PROGRESS',
                payload: {
                    title: 'Backup Complete!',
                    currentStep: 5,
                    totalSteps: 5,
                    currentStepName: '‚úÖ All operations completed successfully',
                    percentage: 100
                }
            });

            addToast('Backup completed successfully! üéâ', 'success');

            // Clear progress and navigate after showing completion
            setTimeout(() => {
                dispatch({ type: 'SET_PROGRESS', payload: null });
                navigate('/certificates');
            }, 3000); // Extended to 3 seconds to see completion
        } catch (error) {
            console.error('Backup failed:', error);
            addToast('Backup operation failed. Please check logs for details.', 'error');
            dispatch({ type: 'SET_PROGRESS', payload: null });
        }
    }; const handleBackToDiscover = () => {
        navigate('/discover');
    };

    const handleViewCertificates = () => {
        navigate('/certificates');
    };

    if (!state.selectedDevice) {
        return (
            <div style={{ maxWidth: '800px', margin: '0 auto' }}>
                <div className="card text-center" style={{ padding: '3rem' }}>
                    <div style={{ fontSize: '4rem', marginBottom: '1rem', opacity: 0.3 }}>üì¶</div>
                    <h3 className="font-semibold mb-2">No Device Selected</h3>
                    <p style={{ color: '#64748b', marginBottom: '2rem' }}>
                        Please discover and select a device before running backup operations.
                    </p>
                    <button
                        className="btn btn-primary"
                        onClick={handleBackToDiscover}
                    >
                        üîç Go to Device Discovery
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
            {/* Header Section */}
            <div className="mb-8">
                <div className="flex items-center gap-3 mb-4">
                    <div style={{ 
                        width: '48px', 
                        height: '48px', 
                        background: 'linear-gradient(135deg, #3b82f6 0%, #1e40af 100%)', 
                        borderRadius: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '24px'
                    }}>
                        üõ°Ô∏è
                    </div>
                    <div>
                        <h2 className="font-semibold" style={{ fontSize: '1.875rem', marginBottom: '0.25rem' }}>
                            Encrypted Backup
                        </h2>
                        <p style={{ color: '#64748b', fontSize: '1rem' }}>
                            Secure your data with military-grade AES-256-CTR encryption
                        </p>
                    </div>
                </div>
                
                <div className="alert alert-info" style={{ border: 'none', background: 'linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%)' }}>
                    <div className="flex items-start gap-3">
                        <div style={{ fontSize: '1.25rem' }}>üîê</div>
                        <div>
                            <h4 className="font-semibold mb-2" style={{ color: '#1e40af' }}>Security Features</h4>
                            <div className="grid grid-cols-2 gap-3 text-sm">
                                <div className="flex items-center gap-2">
                                    <span style={{ color: '#16a34a' }}>‚úì</span>
                                    <span>AES-256-CTR Encryption</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span style={{ color: '#16a34a' }}>‚úì</span>
                                    <span>PBKDF2 Key Derivation</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span style={{ color: '#16a34a' }}>‚úì</span>
                                    <span>HMAC-SHA256 Integrity</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <span style={{ color: '#16a34a' }}>‚úì</span>
                                    <span>N=5 Sample Verification</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Device Info */}
            <div className="card mb-6" style={{ background: 'linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%)', border: '1px solid #e2e8f0' }}>
                <div className="flex items-center gap-4 mb-4">
                    <div style={{ 
                        width: '40px', 
                        height: '40px', 
                        background: state.selectedDevice.risk_level === 'CRITICAL' ? '#fee2e2' : '#dcfce7',
                        borderRadius: '10px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '20px'
                    }}>
                        üíæ
                    </div>
                    <div className="flex-1">
                        <h3 className="font-semibold mb-1" style={{ fontSize: '1.125rem' }}>Source Device</h3>
                        <p style={{ color: '#64748b', fontSize: '0.875rem' }}>
                            The device that will be backed up before wiping
                        </p>
                    </div>
                    <div className={`risk-badge ${state.selectedDevice.risk_level.toLowerCase()}`}>
                        {state.selectedDevice.risk_level}
                    </div>
                </div>
                
                <div className="grid grid-cols-3 gap-6">
                    <div className="text-center p-4 bg-white rounded-lg border border-gray-100">
                        <div style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>üè∑Ô∏è</div>
                        <div className="font-medium text-gray-900">{state.selectedDevice.model}</div>
                        <div className="text-xs text-gray-500 mt-1">Model</div>
                    </div>
                    <div className="text-center p-4 bg-white rounded-lg border border-gray-100">
                        <div style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>üìä</div>
                        <div className="font-medium text-gray-900">
                            {(state.selectedDevice.capacity / (1024 ** 3)).toFixed(1)} GB
                        </div>
                        <div className="text-xs text-gray-500 mt-1">Capacity</div>
                    </div>
                    <div className="text-center p-4 bg-white rounded-lg border border-gray-100">
                        <div style={{ fontSize: '1.5rem', marginBottom: '0.5rem' }}>üî¢</div>
                        <div className="font-medium text-gray-900" style={{ fontSize: '0.875rem' }}>
                            {state.selectedDevice.serial}
                        </div>
                        <div className="text-xs text-gray-500 mt-1">Serial Number</div>
                    </div>
                </div>
            </div>

            {/* Backup Configuration */}
            <div className="card mb-6" style={{ background: '#ffffff', border: '1px solid #e2e8f0' }}>
                <div className="flex items-center gap-4 mb-6">
                    <div style={{ 
                        width: '40px', 
                        height: '40px', 
                        background: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                        borderRadius: '10px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '20px'
                    }}>
                        ‚öôÔ∏è
                    </div>
                    <div>
                        <h3 className="font-semibold" style={{ fontSize: '1.25rem', marginBottom: '0.25rem' }}>
                            Backup Configuration
                        </h3>
                        <p style={{ color: '#64748b', fontSize: '0.875rem' }}>
                            Configure your backup settings and select files to protect
                        </p>
                    </div>
                </div>

                {/* Critical Disk Warning */}
                {state.selectedDevice.risk_level === 'CRITICAL' && (
                    <div className="alert alert-warning mb-6" style={{ 
                        background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)',
                        border: '1px solid #f59e0b',
                        borderRadius: '12px'
                    }}>
                        <div className="flex items-start gap-4">
                            <div style={{ fontSize: '2rem' }}>üñ•Ô∏è</div>
                            <div className="flex-1">
                                <h4 className="font-semibold mb-3" style={{ color: '#92400e', fontSize: '1.125rem' }}>
                                    System Disk Backup Mode
                                </h4>
                                <p className="mb-4" style={{ color: '#78350f' }}>
                                    Backing up from system disk. Only user files will be included by default for safety:
                                </p>
                                <div className="grid grid-cols-2 gap-3 mb-4">
                                    <div className="flex items-center gap-2">
                                        <span style={{ color: '#16a34a' }}>‚úì</span>
                                        <span className="text-sm">Documents folder</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span style={{ color: '#16a34a' }}>‚úì</span>
                                        <span className="text-sm">Pictures folder</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span style={{ color: '#16a34a' }}>‚úì</span>
                                        <span className="text-sm">Videos folder</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span style={{ color: '#16a34a' }}>‚úì</span>
                                        <span className="text-sm">Music folder</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span style={{ color: '#16a34a' }}>‚úì</span>
                                        <span className="text-sm">Desktop folder</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span style={{ color: '#16a34a' }}>‚úì</span>
                                        <span className="text-sm">Downloads folder</span>
                                    </div>
                                </div>
                                <div className="flex items-center gap-2 p-3 bg-white bg-opacity-50 rounded-lg">
                                    <span style={{ color: '#dc2626' }}>‚ö†Ô∏è</span>
                                    <span className="text-sm" style={{ color: '#78350f' }}>
                                        System files and applications will be excluded automatically for security.
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                    <div className="form-group">
                        <label className="form-label">Destination Folder</label>
                        <div className="flex gap-2">
                            <input
                                type="text"
                                className="form-input"
                                value={destination}
                                onChange={(e) => setDestination(e.target.value)}
                                placeholder="~/SecureWipe/backups"
                            />
                            <button
                                className="btn btn-secondary"
                                onClick={handleSelectDestination}
                            >
                                üìÅ Browse
                            </button>
                        </div>
                    </div>

                    {state.selectedDevice.risk_level === 'CRITICAL' && (
                        <div className="form-group">
                            <label className="form-label">
                                <input
                                    type="checkbox"
                                    checked={useDefaultPaths}
                                    onChange={(e) => setUseDefaultPaths(e.target.checked)}
                                    className="mr-2"
                                />
                                Use default user directories (recommended)
                            </label>
                            <div className="text-xs" style={{ color: '#64748b', marginTop: '0.5rem' }}>
                                Safe selection of common user folders, excluding system files.
                            </div>
                        </div>
                    )}

                {!useDefaultPaths && (
                    <div className="mt-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h4 className="font-semibold" style={{ fontSize: '1.125rem', marginBottom: '0.25rem' }}>
                                    {state.selectedDevice.risk_level === 'CRITICAL' 
                                        ? 'Custom Additional Files/Folders' 
                                        : 'Select Files and Folders to Backup'
                                    }
                                </h4>
                                <p style={{ color: '#64748b', fontSize: '0.875rem' }}>
                                    {state.selectedDevice.risk_level === 'CRITICAL' 
                                        ? 'Advanced: Only select files outside the default user directories if absolutely necessary.'
                                        : 'Browse and select specific files and folders for your backup.'
                                    }
                                </p>
                            </div>
                            <button
                                className="btn btn-primary"
                                onClick={() => setShowFileBrowser(!showFileBrowser)}
                                style={{ 
                                    background: showFileBrowser 
                                        ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'
                                        : 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                                    minWidth: '160px'
                                }}
                            >
                                {showFileBrowser ? 'üìÅ Hide Browser' : 'üìÅ Browse Files'}
                            </button>
                        </div>

                        {selectedFiles.length > 0 && (
                            <div className="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                <div className="flex items-center gap-3 mb-3">
                                    <div style={{ 
                                        width: '32px', 
                                        height: '32px', 
                                        background: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                                        borderRadius: '8px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '16px'
                                    }}>
                                        üìÑ
                                    </div>
                                    <div>
                                        <h5 className="font-semibold text-blue-900">
                                            {selectedFiles.length} Item{selectedFiles.length !== 1 ? 's' : ''} Selected
                                        </h5>
                                        <p className="text-sm text-blue-700">
                                            These files and folders will be included in your backup
                                        </p>
                                    </div>
                                </div>
                                <div className="max-h-32 overflow-y-auto space-y-1">
                                    {selectedFiles.map((path, index) => (
                                        <div key={index} className="flex items-center gap-2 text-sm bg-white bg-opacity-60 p-2 rounded">
                                            <span style={{ color: '#3b82f6' }}>üìÑ</span>
                                            <span className="font-mono text-gray-700 truncate flex-1">{path}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {showFileBrowser && (
                            <div className="mb-4 p-6 bg-gray-50 rounded-xl border border-gray-200">
                                <div className="flex items-center gap-3 mb-4">
                                    <div style={{ 
                                        width: '32px', 
                                        height: '32px', 
                                        background: 'linear-gradient(135deg, #6366f1 0%, #4f46e5 100%)',
                                        borderRadius: '8px',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        fontSize: '16px'
                                    }}>
                                        üóÇÔ∏è
                                    </div>
                                    <div>
                                        <h5 className="font-semibold text-gray-900">File Browser</h5>
                                        <p className="text-sm text-gray-600">
                                            Navigate and select files and folders for your backup
                                        </p>
                                    </div>
                                </div>
                                <FileBrowser
                                    onSelectionChange={setSelectedFiles}
                                    multiSelect={true}
                                    allowFiles={true}
                                    allowFolders={true}
                                    maxSelectionSize={50 * 1024 * 1024 * 1024} // 50GB warning
                                    title="Select Files and Folders for Backup"
                                />
                            </div>
                        )}
                    </div>
                )}

                    <div className="form-group">
                        <label className="form-label">Signing Key Path (Optional)</label>
                        <input
                            type="text"
                            className="form-input"
                            value={signKeyPath}
                            onChange={(e) => setSignKeyPath(e.target.value)}
                            placeholder="Path to private key for certificate signing"
                        />
                        <div className="text-xs" style={{ color: '#64748b', marginTop: '0.5rem' }}>
                            Leave empty to use default development key. Specify custom key for production use.
                        </div>
                    </div>

                    {/* Encryption Info */}
                    <div className="alert alert-info">
                        <h4 className="font-semibold mb-2">üîê Encryption Details</h4>
                        <div className="text-sm grid grid-cols-2 gap-4">
                            <div>
                                <span className="font-medium">Algorithm:</span> AES-256-CTR
                            </div>
                            <div>
                                <span className="font-medium">Key Derivation:</span> PBKDF2
                            </div>
                            <div>
                                <span className="font-medium">Integrity:</span> HMAC-SHA256
                            </div>
                            <div>
                                <span className="font-medium">Verification:</span> N=5 sample checks
                            </div>
                        </div>
                    </div>
                </div>

                {/* Action Button */}
                <button
                    className="btn btn-primary btn-large mb-6"
                    onClick={handleRunBackup}
                    disabled={state.isLoading || running}
                    style={{ width: '100%' }}
                >
                    {(state.isLoading || running) ? 'üîÑ Running Backup...' : 'üõ°Ô∏è Run Backup (Encrypted)'}
                </button>

                {/* Progress Indicator */}
                {state.isLoading && state.progress && (
                    <Progress
                        title={state.progress.title}
                        currentStep={state.progress.currentStep}
                        totalSteps={state.progress.totalSteps}
                        currentStepName={state.progress.currentStepName}
                        percentage={state.progress.percentage}
                        className="mb-6"
                    />
                )}
            </div>

            {/* Operation Logs */}
            {state.logs.length > 0 && (
                <div className="mb-6">
                    <LogViewer
                        logs={state.logs}
                        title="Backup Progress"
                    />
                </div>
            )}

            {/* Backup Results */}
            {state.backupResult && (
                <div className="mb-6">
                    <div className="card">
                        <h3 className="font-semibold mb-4">‚úÖ Backup Completed Successfully</h3>

                        <div className="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <h4 className="font-semibold mb-3">Backup Summary</h4>
                                <div className="text-sm space-y-2">
                                    <div>
                                        <span className="font-medium">Location:</span>
                                        <div className="mt-1">{state.backupResult.backup_path}</div>
                                    </div>
                                    <div>
                                        <span className="font-medium">Integrity Checks:</span>
                                        <div className="mt-1">{state.backupResult.integrity_checks} samples verified ‚úì</div>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <h4 className="font-semibold mb-3">Generated Files</h4>
                                <div className="space-y-2">
                                    <FileLink
                                        path={state.backupResult.backup_path}
                                        label="Open Backup Folder"
                                        type="folder"
                                    />
                                    <FileLink
                                        path={state.backupResult.manifest_path}
                                        label="Backup Manifest"
                                        type="json"
                                    />
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4 mb-6">
                            {state.backupResult.certificate_json_path && (
                                <FileLink
                                    path={state.backupResult.certificate_json_path}
                                    label="Backup Certificate (JSON)"
                                    type="json"
                                />
                            )}
                            {state.backupResult.certificate_pdf_path && (
                                <FileLink
                                    path={state.backupResult.certificate_pdf_path}
                                    label="Backup Certificate (PDF)"
                                    type="pdf"
                                />
                            )}
                        </div>

                        <div className="flex gap-4">
                            <button
                                className="btn btn-primary"
                                onClick={handleViewCertificates}
                            >
                                üìú View All Certificates
                            </button>

                            <button
                                className="btn btn-secondary"
                                onClick={() => window.open('http://localhost:8000', '_blank')}
                            >
                                üåê Open in Portal Verify
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Current Operation Status */}
            {state.currentOperation && (
                <div className="alert alert-info">
                    <div className="flex items-center gap-2">
                        <div style={{
                            width: '20px',
                            height: '20px',
                            border: '2px solid #3b82f6',
                            borderTopColor: 'transparent',
                            borderRadius: '50%',
                            animation: 'spin 1s linear infinite'
                        }}></div>
                        <span>{state.currentOperation}</span>
                    </div>
                </div>
            )}
        </div>
    );
}

export default Backup;
